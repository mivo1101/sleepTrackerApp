<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <% const resolvedTitle = typeof title === 'undefined' || title === null ? '' : title; %>
    <title><%= resolvedTitle ? `${resolvedTitle} | ` : '' %>Alive Sleep Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/css/header.css" />
    <script src="/socket.io/socket.io.js"></script>
    <script>
      // Initialize Socket.IO connection immediately
      console.log('[Init] Socket.IO script loading...');
      const socket = io();
      window.socket = socket; // Store globally
      console.log('[Init] Socket.IO client created:', socket);
      
      socket.on('connect', () => {
        console.log('[Init] Socket connected with ID:', socket.id);
      });
      
      socket.on('disconnect', () => {
        console.log('[Init] Socket disconnected');
      });
      
      // Global notification listener - this will work on any page
      socket.on('schedule:notification', (data) => {
        console.log('[Init] Received notification:', data);
        
        // Show the notification popup immediately
        if (data.type === 'bedtime') {
          showNotificationPopup(data);
        }
      });

      // Global variable to track if notification is beeping
      let isBeeping = false;
      let beeperInterval = null;
      
      // Function to play notification sound
      function playNotificationSound() {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          playBeep(audioContext);
        } catch (e) {
          console.log('[Sound] Audio context error:', e.message);
        }
      }
      
      // Function to actually play the beep sound
      function playBeep(audioContext) {
        try {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          // Set frequency and duration for a pleasant beep
          oscillator.frequency.value = 800; // Hz
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.5);
          console.log('[Sound] Beep played');
        } catch (e) {
          console.log('[Sound] Error playing beep:', e.message);
        }
      }
      
      // Function to start continuous beeping
      function startContinuousBeep() {
        if (isBeeping) return;
        isBeeping = true;
        console.log('[Sound] Starting continuous beep');
        
        // Play beep immediately
        playNotificationSound();
        
        // Play beep every 1 second
        beeperInterval = setInterval(() => {
          if (isBeeping) {
            playNotificationSound();
          }
        }, 1000);
      }
      
      // Function to stop continuous beeping
      function stopContinuousBeep() {
        isBeeping = false;
        if (beeperInterval) {
          clearInterval(beeperInterval);
          beeperInterval = null;
        }
        console.log('[Sound] Stopped continuous beep');
      }

      // Function to show notification popup
      function showNotificationPopup(notification) {
        console.log('[Popup] Creating notification UI...');
        
        // Create notification element
        const notifDiv = document.createElement('div');
        notifDiv.className = 'bedtime-notification';
        
        notifDiv.innerHTML = `
          <div class="notif-content">
            <h4>${notification.title || 'Bedtime Reminder'}</h4>
            <p>${notification.message || 'Time for bed!'}</p>
            <small>${new Date(notification.timestamp).toLocaleTimeString()}</small>
          </div>
          <div class="notif-buttons" style="display:flex;gap:10px;margin-left:15px;">
            <button class="notif-stop" style="background:#ff4757;border:none;color:white;padding:8px 15px;border-radius:4px;cursor:pointer;font-weight:bold;">STOP</button>
            <button class="notif-close" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;padding:0;margin-left:5px;">Ã—</button>
          </div>
        `;
        
        // Apply inline styles
        notifDiv.style.position = 'fixed';
        notifDiv.style.top = '80px';
        notifDiv.style.right = '20px';
        notifDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        notifDiv.style.color = 'white';
        notifDiv.style.padding = '20px';
        notifDiv.style.borderRadius = '8px';
        notifDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        notifDiv.style.maxWidth = '450px';
        notifDiv.style.zIndex = '9999';
        notifDiv.style.display = 'flex';
        notifDiv.style.alignItems = 'center';
        notifDiv.style.justifyContent = 'space-between';
        notifDiv.style.animation = 'slideIn 0.3s ease-out';
        
        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideIn {
            from {
              transform: translateX(450px);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
          .notif-stop:hover {
            background: #ff6b7a !important;
          }
        `;
        document.head.appendChild(style);
        
        // Add to page
        document.body.appendChild(notifDiv);
        console.log('[Popup] Notification added to page');
        
        // Start continuous beeping immediately
        startContinuousBeep();
        
        // Stop button functionality
        const stopBtn = notifDiv.querySelector('.notif-stop');
        stopBtn.addEventListener('click', () => {
          console.log('[Popup] Stopped notification');
          stopContinuousBeep();
          notifDiv.remove();
        });
        
        // Close button functionality
        const closeBtn = notifDiv.querySelector('.notif-close');
        closeBtn.addEventListener('click', () => {
          stopContinuousBeep();
          notifDiv.remove();
        });
        
        // Auto-remove after 60 seconds (if user doesn't stop it)
        setTimeout(() => {
          if (notifDiv.parentElement) {
            stopContinuousBeep();
            notifDiv.remove();
          }
        }, 60000);
      }
    </script>
  </head>

  <body class="grey lighten-5">
    <div class="navbar-fixed">
        <nav class="z-depth-0 top-nav">
            <div class="nav-shell">
                
                <div class="nav-left">
                    <a href="/" class="nav-brand">
                        <img src="/img/logo/logo-horizontal.svg" alt="Alive logo" class="brand-logo" />
                    </a>
                </div>

                <a href="#" data-target="mobile-nav" class="sidenav-trigger black-text hide-on-med-and-up">
                    <i class="material-icons">menu</i>
                </a>

                <div class="nav-center hide-on-small-and-down">
                    <div class="nav-pill">
                        <ul class="nav-menu">
                            <%- include('./navMenu') %>
                        </ul>
                    </div>
                </div>

                <div class="nav-right hide-on-small-and-down">
                    <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated) { %>
                        <span class="user-name-label grey-text text-darken-4">
                            <%= (typeof user !== 'undefined' && user.name) ? user.name : 'User' %>
                        </span>
                        
                        <a href="/dashboard/schedules" class="btn-floating btn-small blue lighten-4 z-depth-0 notification-bell" title="View Schedules">
                            <i class="material-icons blue-text">notifications_none</i>
                        </a>
                
                        <% if (typeof isDashboard !== 'undefined' && isDashboard) { %>
                            <a href="/" class="nav-signin black">Main Site</a>
                        <% } else { %>
                            <a href="/dashboard" class="nav-signin black">Dashboard</a>
                        <% } %>
                        
                        <a href="/auth/logout" class="nav-signout-link grey-text">Sign Out</a>
                    <% } else { %>
                        <a href="/auth/login" class="nav-signin black">Sign In</a>
                    <% } %>
                </div>
                
            </div>
        </nav>
    </div>

    <ul class="sidenav" id="mobile-nav">
      <%- include('./navMenu') %>
      <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated) { %>
        <li><a href="/dashboard">Dashboard</a></li>
        <li><a href="/auth/logout">Sign Out</a></li>
      <% } else { %>
        <li><a href="/auth/login">Sign In</a></li>
      <% } %>
    </ul>

